PREHOOK: query: -- see HIVE-4033 earlier a flag named hasVC was not initialized correctly in MapOperator.java, resulting in NPE for following query. order by and limit in the query is not relevant, problem would be evident even without those. They are there to keep .q.out file small and sorted.

-- SORT_QUERY_RESULTS

explain select t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value from src t1 join src t2 on t1.key = t2.key join src t3 on t2.value = t3.value order by t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value limit 3
PREHOOK: type: QUERY
POSTHOOK: query: -- see HIVE-4033 earlier a flag named hasVC was not initialized correctly in MapOperator.java, resulting in NPE for following query. order by and limit in the query is not relevant, problem would be evident even without those. They are there to keep .q.out file small and sorted.

-- SORT_QUERY_RESULTS

explain select t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value from src t1 join src t2 on t1.key = t2.key join src t3 on t2.value = t3.value order by t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value limit 3
POSTHOOK: type: QUERY
STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-2 depends on stages: Stage-1
  Stage-3 depends on stages: Stage-2
  Stage-0 depends on stages: Stage-3

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: t1
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: key is not null (type: boolean)
              Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
              Reduce Output Operator
                key expressions: key (type: string)
                sort order: +
                Map-reduce partition columns: key (type: string)
                Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
          TableScan
            alias: t2
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (key is not null and value is not null) (type: boolean)
              Statistics: Num rows: 125 Data size: 1328 Basic stats: COMPLETE Column stats: NONE
              Reduce Output Operator
                key expressions: key (type: string)
                sort order: +
                Map-reduce partition columns: key (type: string)
                Statistics: Num rows: 125 Data size: 1328 Basic stats: COMPLETE Column stats: NONE
                value expressions: value (type: string)
      Reduce Operator Tree:
        Join Operator
          condition map:
               Inner Join 0 to 1
          keys:
            0 key (type: string)
            1 key (type: string)
          outputColumnNames: _col6
          Statistics: Num rows: 275 Data size: 2921 Basic stats: COMPLETE Column stats: NONE
          File Output Operator
            compressed: false
            table:
                input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe

  Stage: Stage-2
    Map Reduce
      Map Operator Tree:
          TableScan
            Reduce Output Operator
              key expressions: _col6 (type: string)
              sort order: +
              Map-reduce partition columns: _col6 (type: string)
              Statistics: Num rows: 275 Data size: 2921 Basic stats: COMPLETE Column stats: NONE
          TableScan
            alias: t3
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: value is not null (type: boolean)
              Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
              Reduce Output Operator
                key expressions: value (type: string)
                sort order: +
                Map-reduce partition columns: value (type: string)
                Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE
                value expressions: key (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint)
      Reduce Operator Tree:
        Join Operator
          condition map:
               Inner Join 0 to 1
          keys:
            0 _col6 (type: string)
            1 value (type: string)
          outputColumnNames: _col10, _col11, _col12
          Statistics: Num rows: 302 Data size: 3213 Basic stats: COMPLETE Column stats: NONE
          Select Operator
            expressions: _col12 (type: bigint), _col10 (type: string), _col11 (type: string)
            outputColumnNames: _col0, _col1, _col2
            Statistics: Num rows: 302 Data size: 3213 Basic stats: COMPLETE Column stats: NONE
            File Output Operator
              compressed: false
              table:
                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                  serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe

  Stage: Stage-3
    Map Reduce
      Map Operator Tree:
          TableScan
            Reduce Output Operator
              key expressions: _col0 (type: bigint), _col1 (type: string), _col2 (type: string)
              sort order: +++
              Statistics: Num rows: 302 Data size: 3213 Basic stats: COMPLETE Column stats: NONE
      Reduce Operator Tree:
        Select Operator
          expressions: KEY.reducesinkkey0 (type: bigint), KEY.reducesinkkey1 (type: string), KEY.reducesinkkey2 (type: string)
          outputColumnNames: _col0, _col1, _col2
          Statistics: Num rows: 302 Data size: 3213 Basic stats: COMPLETE Column stats: NONE
          Limit
            Number of rows: 3
            Statistics: Num rows: 3 Data size: 30 Basic stats: COMPLETE Column stats: NONE
            File Output Operator
              compressed: false
              Statistics: Num rows: 3 Data size: 30 Basic stats: COMPLETE Column stats: NONE
              table:
                  input format: org.apache.hadoop.mapred.TextInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: 3
      Processor Tree:
        ListSink

PREHOOK: query: select t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value from src t1 join src t2 on t1.key = t2.key join src t3 on t2.value = t3.value order by t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value limit 3
PREHOOK: type: QUERY
PREHOOK: Input: default@src
#### A masked pattern was here ####
POSTHOOK: query: select t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value from src t1 join src t2 on t1.key = t2.key join src t3 on t2.value = t3.value order by t3.BLOCK__OFFSET__INSIDE__FILE,t3.key,t3.value limit 3
POSTHOOK: type: QUERY
POSTHOOK: Input: default@src
#### A masked pattern was here ####
0	238	val_238
0	238	val_238
0	238	val_238
PREHOOK: query: explain
select t2.BLOCK__OFFSET__INSIDE__FILE
from src t1 join src t2 on t1.key = t2.key where t1.key < 100 order by t2.BLOCK__OFFSET__INSIDE__FILE
PREHOOK: type: QUERY
POSTHOOK: query: explain
select t2.BLOCK__OFFSET__INSIDE__FILE
from src t1 join src t2 on t1.key = t2.key where t1.key < 100 order by t2.BLOCK__OFFSET__INSIDE__FILE
POSTHOOK: type: QUERY
STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-2 depends on stages: Stage-1
  Stage-0 depends on stages: Stage-2

STAGE PLANS:
  Stage: Stage-1
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: t1
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (UDFToDouble(key) < 100.0) (type: boolean)
              Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: key (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint)
                outputColumnNames: _col0, _col1
                Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
                Reduce Output Operator
                  key expressions: _col0 (type: string)
                  sort order: +
                  Map-reduce partition columns: _col0 (type: string)
                  Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
                  value expressions: _col1 (type: bigint)
          TableScan
            alias: t1
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (UDFToDouble(key) < 100.0) (type: boolean)
              Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: key (type: string)
                outputColumnNames: _col0
                Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
                Reduce Output Operator
                  key expressions: _col0 (type: string)
                  sort order: +
                  Map-reduce partition columns: _col0 (type: string)
                  Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
      Reduce Operator Tree:
        Join Operator
          condition map:
               Inner Join 0 to 1
          keys:
            0 _col0 (type: string)
            1 _col0 (type: string)
          outputColumnNames: _col1
          Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
          Select Operator
            expressions: _col1 (type: bigint)
            outputColumnNames: _col0
            Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
            File Output Operator
              compressed: false
              table:
                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                  serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe

  Stage: Stage-2
    Map Reduce
      Map Operator Tree:
          TableScan
            Reduce Output Operator
              key expressions: _col0 (type: bigint)
              sort order: +
              Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
      Reduce Operator Tree:
        Select Operator
          expressions: KEY.reducesinkkey0 (type: bigint)
          outputColumnNames: _col0
          Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
          File Output Operator
            compressed: false
            Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
            table:
                input format: org.apache.hadoop.mapred.TextInputFormat
                output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink

PREHOOK: query: select t2.BLOCK__OFFSET__INSIDE__FILE
from src t1 join src t2 on t1.key = t2.key where t1.key < 100 order by t2.BLOCK__OFFSET__INSIDE__FILE
PREHOOK: type: QUERY
PREHOOK: Input: default@src
#### A masked pattern was here ####
POSTHOOK: query: select t2.BLOCK__OFFSET__INSIDE__FILE
from src t1 join src t2 on t1.key = t2.key where t1.key < 100 order by t2.BLOCK__OFFSET__INSIDE__FILE
POSTHOOK: type: QUERY
POSTHOOK: Input: default@src
#### A masked pattern was here ####
1024
1118
1176
1198
12
1208
1208
1218
1238
1238
1238
1440
1462
1462
1592
1674
1674
1720
1720
1754
1754
1872
1872
1906
1906
1916
1972
1972
198
2030
2030
2088
2088
2088
2216
2226
2226
2308
2308
2330
2400
2400
2458
2458
2612
2622
2632
2632
2632
2652
2770
2770
2792
2792
2802
2802
2802
2824
2846
3060
3060
3060
3128
3128
3138
3138
3138
3160
3160
3170
3192
328
328
3298
3298
3368
3378
3378
3388
34
3494
3516
3538
3538
3548
3570
3592
3794
3794
3794
386
386
3864
3864
3864
396
4004
4012
4012
4012
4058
4068
4186
4304
4304
4304
4362
4362
4540
4540
4540
4548
4548
4548
4594
4594
4640
4640
4640
5070
5070
5284
5284
5306
5306
5340
5340
5398
5514
5514
5572
5572
5606
5606
5616
5626
5626
5744
5744
5744
5802
5802
910
92
92
968
968
968
PREHOOK: query: -- HIVE-4790 MapredLocalTask does not make virtual columns

explain
SELECT *,a.BLOCK__OFFSET__INSIDE__FILE FROM src a JOIN src b ON a.key = b.key where a.key < 50 order by a.key, a.BLOCK__OFFSET__INSIDE__FILE
PREHOOK: type: QUERY
POSTHOOK: query: -- HIVE-4790 MapredLocalTask does not make virtual columns

explain
SELECT *,a.BLOCK__OFFSET__INSIDE__FILE FROM src a JOIN src b ON a.key = b.key where a.key < 50 order by a.key, a.BLOCK__OFFSET__INSIDE__FILE
POSTHOOK: type: QUERY
STAGE DEPENDENCIES:
  Stage-5 is a root stage
  Stage-2 depends on stages: Stage-5
  Stage-0 depends on stages: Stage-2

STAGE PLANS:
  Stage: Stage-5
    Map Reduce Local Work
      Alias -> Map Local Tables:
        $hdt$_0:a 
          Fetch Operator
            limit: -1
      Alias -> Map Local Operator Tree:
        $hdt$_0:a 
          TableScan
            alias: a
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (UDFToDouble(key) < 50.0) (type: boolean)
              Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: key (type: string), value (type: string), BLOCK__OFFSET__INSIDE__FILE (type: bigint)
                outputColumnNames: _col0, _col1, _col2
                Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
                HashTable Sink Operator
                  keys:
                    0 _col0 (type: string)
                    1 _col0 (type: string)

  Stage: Stage-2
    Map Reduce
      Map Operator Tree:
          TableScan
            alias: a
            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE
            Filter Operator
              predicate: (UDFToDouble(key) < 50.0) (type: boolean)
              Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
              Select Operator
                expressions: key (type: string), value (type: string)
                outputColumnNames: _col0, _col1
                Statistics: Num rows: 166 Data size: 1763 Basic stats: COMPLETE Column stats: NONE
                Map Join Operator
                  condition map:
                       Inner Join 0 to 1
                  keys:
                    0 _col0 (type: string)
                    1 _col0 (type: string)
                  outputColumnNames: _col0, _col1, _col2, _col3, _col4
                  Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
                  Select Operator
                    expressions: _col0 (type: string), _col1 (type: string), _col3 (type: string), _col4 (type: string), _col2 (type: bigint)
                    outputColumnNames: _col0, _col1, _col2, _col3, _col4
                    Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
                    Reduce Output Operator
                      key expressions: _col0 (type: string), _col4 (type: bigint)
                      sort order: ++
                      Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
                      value expressions: _col1 (type: string), _col2 (type: string), _col3 (type: string)
      Local Work:
        Map Reduce Local Work
      Reduce Operator Tree:
        Select Operator
          expressions: KEY.reducesinkkey0 (type: string), VALUE._col0 (type: string), VALUE._col1 (type: string), VALUE._col2 (type: string), KEY.reducesinkkey1 (type: bigint)
          outputColumnNames: _col0, _col1, _col2, _col3, _col4
          Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
          File Output Operator
            compressed: false
            Statistics: Num rows: 182 Data size: 1939 Basic stats: COMPLETE Column stats: NONE
            table:
                input format: org.apache.hadoop.mapred.TextInputFormat
                output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
                serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink

PREHOOK: query: SELECT *,a.BLOCK__OFFSET__INSIDE__FILE FROM src a JOIN src b ON a.key = b.key where a.key < 50 order by a.key, a.BLOCK__OFFSET__INSIDE__FILE
PREHOOK: type: QUERY
PREHOOK: Input: default@src
#### A masked pattern was here ####
POSTHOOK: query: SELECT *,a.BLOCK__OFFSET__INSIDE__FILE FROM src a JOIN src b ON a.key = b.key where a.key < 50 order by a.key, a.BLOCK__OFFSET__INSIDE__FILE
POSTHOOK: type: QUERY
POSTHOOK: Input: default@src
#### A masked pattern was here ####
0	val_0	0	val_0	2088
0	val_0	0	val_0	2088
0	val_0	0	val_0	2088
0	val_0	0	val_0	2632
0	val_0	0	val_0	2632
0	val_0	0	val_0	2632
0	val_0	0	val_0	968
0	val_0	0	val_0	968
0	val_0	0	val_0	968
10	val_10	10	val_10	2846
11	val_11	11	val_11	3170
12	val_12	12	val_12	1720
12	val_12	12	val_12	1720
12	val_12	12	val_12	4362
12	val_12	12	val_12	4362
15	val_15	15	val_15	2770
15	val_15	15	val_15	2770
15	val_15	15	val_15	386
15	val_15	15	val_15	386
17	val_17	17	val_17	910
18	val_18	18	val_18	5340
18	val_18	18	val_18	5340
18	val_18	18	val_18	5514
18	val_18	18	val_18	5514
19	val_19	19	val_19	2824
2	val_2	2	val_2	4004
20	val_20	20	val_20	1118
24	val_24	24	val_24	1972
24	val_24	24	val_24	1972
24	val_24	24	val_24	4594
24	val_24	24	val_24	4594
26	val_26	26	val_26	2226
26	val_26	26	val_26	2226
26	val_26	26	val_26	5284
26	val_26	26	val_26	5284
27	val_27	27	val_27	34
28	val_28	28	val_28	5616
30	val_30	30	val_30	3494
33	val_33	33	val_33	3592
34	val_34	34	val_34	3192
35	val_35	35	val_35	1238
35	val_35	35	val_35	1238
35	val_35	35	val_35	1238
35	val_35	35	val_35	3138
35	val_35	35	val_35	3138
35	val_35	35	val_35	3138
35	val_35	35	val_35	4012
35	val_35	35	val_35	4012
35	val_35	35	val_35	4012
37	val_37	37	val_37	328
37	val_37	37	val_37	328
37	val_37	37	val_37	5626
37	val_37	37	val_37	5626
4	val_4	4	val_4	1218
41	val_41	41	val_41	3388
42	val_42	42	val_42	2030
42	val_42	42	val_42	2030
42	val_42	42	val_42	3298
42	val_42	42	val_42	3298
43	val_43	43	val_43	2330
44	val_44	44	val_44	4068
47	val_47	47	val_47	1198
5	val_5	5	val_5	3060
5	val_5	5	val_5	3060
5	val_5	5	val_5	3060
5	val_5	5	val_5	3864
5	val_5	5	val_5	3864
5	val_5	5	val_5	3864
5	val_5	5	val_5	4540
5	val_5	5	val_5	4540
5	val_5	5	val_5	4540
8	val_8	8	val_8	1916
9	val_9	9	val_9	5398
